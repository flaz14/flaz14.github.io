<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Netcat отжил свое</title>
	</head>

	<body>
		<h1>
			<big>
				<a href="/#netcat-is-too-old" title="Перейти к оглавлению">&larr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>

		<hr>

		<h1>
			<a href="http://flaz14.github.io/netcat-is-too-old/netcat-is-too-old.html">
				Netcat отжил свое
			</a>
		</h1>
		
		<h3>[2017, Декабрь]</h3>

		<h3>
			<a href="Тут будет ссылка на исходный код. А может, и не будет.">
				Исходный код
			</a>
		</h3>
		
		<h2>Netcat - тысячи их</h2>
		
		
		--------
		https://nmap.org/ncat/
		--------
		
		
		<p>
			Однажды в 17-ом номере журнала <a href="http://dgmag.in/">Downgrade</a> я прочитал статью 
			<strong>Издеваемся над файловой системой</strong> за авторством <em>uav1606</em>. Отличная статья! Так что я
			решил проделать то же самое, только в Linux.
		
		<p>
			Как известно, Linux поддерживает <strong>Unicode</strong> "из-коробки", т.е. не только на уровне файловой 
			системы, но и в эмуляторах терминала и т.п. В Unicode символов гораздо больше, чем в таблице ASCII. И выбор 
			их огромен (в частности, псевдографических символов в Unicode навалом). Но это не главное. Рисовать можно и 
			с помощью стандартных символов (т.е. с кодами до 127). Возможная проблема, как сказал автор, состоит в том, 
			что нельзя создать два каталога/файла с одним именем. Решить ее в DOS можно за счет использования 
			расширения. Автор говорил, что можно использовать в расширении комбинации символов с кодом 255 (пустой 
			символ в таблице ASCII) чтобы они не портили рисунок. Но можно использовать и обычные, т.е. видимые символы.
			По-моему, рисунок они не испортят. А если и испортят, то не сильно. Потому что файловые менеджеры DOS 
			показывают расширение файла/каталога поодаль от его имени. Так, <i>Norton/Volcov Commander</i> в колонке 
			<b>Name</b> выравнивают собственно имя файла/каталога по левому краю, а расширение - по правому (см. 
			<a href="#illustration-1">рисунок 1</a>). А поскольку расширения тусуются отдельно, они не сильно будут
			мешать восприятию рисунка.

<h4 id="illustration-1">Рисунок 1 - в файловых менеджерах DOS расширение отображается отдельно от имени</h4>
<p>
	<img 
	src="illustrations/dos-commanders-names-and-extenstions.png"
	width="320px"
	alt="скриншот двухпанельного файлового менеджера DOS; виден листинг корня диска C">
		
		<p id="note-about-extensions-in-DOS">
			Если задавать расширение с помощью только цифр, то получится 1000 уникальных комбинаций. Но в расширении 
			можно использовать не только цифры. Можно взять цифры, буквы, символ почеркивания и т.д. А затем создавать 
			из них тройки. Возможных комбинаций хватит на любой ASCII-рисунок (в пределах разумного, конечно).
			
		<p id="note-about-sorting-by-name">
			Вторая проблема (строго говоря, это не проблема, а личное предпочтение): по-умолчанию в большинстве файловых
			менеджеров сортировка листинга каталога осуществляется по имени содержащихся в нем объектов. По-моему,
			"рисованный" каталог, который не требует для своего корректного отображения дополнительного шаманства (т.е. 
			установки вручную режима сортировки по расширению либо по дате модификации и т.п.) - гораздо круче и 
			изящнее. Здесь на сцену и выходит Unicode.
		
		<p>
			Если в ASCII есть только один пустой символ (не считая настоящего пробела с кодом 32) - символ с кодом 255, 
			то в Unicode пробелов гораздо больше. Вгляните сами на таблицу 
			<a href="http://jkorpela.fi/chars/spaces.html">Unicode spaces</a>. Но не все Unicode-пробелы "хорошие".
			Например, пробел <code>U+1680</code> отображается в терминале в виде закорючки непонятной. Пробел 
			<code>U+180E</code>, как сказано в комментарии к вышеупомянутой таблице, не имеет длины, т.е. отображается 
			в терминале как пустое место. А пробел <code>U+3000</code>, наоборот, выглядит в терминале слишком толстым, 
			т.е. занимает не одно, а целых два знакоместа. Некоторые символы, такие как <code>U+200B</code> и 
			<code>U+FEFF</code>, вовсе не задумывались как визуально различимые, так что от их использования тоже лучше 
			отказаться. Как бы то ни было, можно выбрать действительно хорошие Unicode-пробелы, которые не корежатся в 
			терминале и выглядят все как один (в силу того, что в консоли используется моноширинный шрифт).
		
		<p>
			Кроме пробелов, есть в Unicode символы, которые не являются пробелами, но выглядят пустыми. Например, 
			арабские символы <code>U+0600</code> - <code>U+0604</code> выглядят пустыми в таблице символов (я 
			использовал для их просмотра программу 
			<a href="https://wiki.gnome.org/action/show/Apps/Gucharmap?action=show&amp;redirect=Gucharmap">
			GNOME Character Map</a>, основанную на версии Unicode 6.3.0). Они приведены на 
			<a href="#illustration-2">рисунке 2</a>. 

<h4 id="illustration-2">Рисунок 2 - арабские символы в программе GNOME Character Map</h4>	
<p>
	<img 
	src="illustrations/arabic-characters-in-table.png"
	width="480px"
	alt="скриншот первых символов группы Arabic в таблице GNOME Character Map">
		
		<p>	
			Но появление этих символов в терминале приводит к забавным эффектам. Так, следующие за ними символы 
			буквально пишутся поверх арабских (что неудивительно, ведь мы смешали символы из языков, в которых 
			пишут справа налево и слева направо). Я просто попытался вывести на экран (из Python-скрипта) символы, 
			заключив их в квадратные скобки. "Обычный" пробел отобразился нормально. А вот арабские символы отобразились
			в виде иероглифов, а не так, как они выглядели в таблице. Кроме того, закрывающие квадратные скобки 
			"наехали" на иероглифы. Эту ситуацию можно наблюдать на <a href="#illustration-3">рисунке 3</a>.

<h4 id="illustration-3">Рисунок 3 - арабские символы в эмуляторе терминала</h4>
<p>
	<img 
	src="illustrations/arabic-characters-in-terminal.png"
	width="320px"
	alt="скриншот эмулятора терминала; для сравнения расположения символов первым приведен обычный пробел (ASCII 32)">
		
		<p>
			Как бы то ни было, наскрести в таблице Unicode десяток-другой "хороших" пробелов можно. Естественно, их 
			можно комбинировать, как в 
			<a href="#note-about-extensions-in-DOS">случае с цифрами и буквами в расширениях</a>. Пробелы уж точно не 
			испортят рисунок. Можно смело добавлять их к каждой строке оригинального рисунка слева и/или справа - никто 
			не заметит.
		
		<p>
			Отлично, мы набрали команду "хороших" пробелов. Но в зависимости от установленной локали (а также шрифтов и,
			может быть, особенностей конкретного эмулятора терминала), "хорошие" пробелы могут стать плохими, т.е. 
			кракозябрами (в Windows, насколько я знаю, аналогичная ситуация с растровыми шрифтами в <i>cmd.exe</i>).
		
		<p>
			Итак, проблема уникальности имен файлов/каталогов при неизменном внешнем виде с помощью Unicode-пробелов
			решаема.
		
		<h2>Сортировка</h2>
			
		<p>
			Посмотрим, какие возможности сортировки листинга каталога предоставляет Linux. Стандартная команда 
			<strong>ls</strong> по-умолчанию выводит содержимое каталога в несколько столбцов, как показано на 
			<a href="#illustration-4">рисунке 4</a>.

<h4 id="illustration-4">Рисунок 4 - отображение листинга каталога командой ls с параметрами по-умочанию</h4>
<p>
	<img 
	src="illustrations/ls-with-default-parameters.png"
	width="480px"
	alt="скриншот эмулятора терминала">
			
		<p>
			С помощью параметра <em>-1</em> (он же <em>--format=single-column</em>) можно вывести содержимое в один
			столбец, как показано на <a href="#illustration-5">рисунке 5</a>.

<h4 id="illustration-5">Рисунок 5 - отображение листинга командой ls в один столбец</h4>
<p>
	<img 
	src="illustrations/ls-with-format-parameter.png"
	width="320px"
	alt="скриншот эмулятора терминала">

		<p>
			Этого достаточно для красивого представления рисунка в консоли.
		
		<p>
			С сортировкой тоже просто. Достаточно применить параметр <em>--sort=WORD</em>:
			<blockquote>
				<p>sort by WORD instead of name: none -U, extension -X,  size -S, time -t, version -v
			</blockquote>
			
		<p>
			Консольный файловый менеджер <a href="https://midnight-commander.org/">Midnight Commander</a> предоставляет 
			несколько больше возможностей для сортировки (см. <a href="#illustration-6">рисунок 6</a>).
			
<h4 id="illustration-6">Рисунок 6 - опции сортировки листинга каталога в Midnight Commander</h4>
<p>
	<img 
	src="illustrations/mc-sorting-options.png"
	width="320px"
	alt="скриншот окошка Sort order">
			
		<p>Разберем их.
		
		<dl>
			<dt>
				Unsorted
			<dd>
				Можно даже не рассматривать. Порядок элементов в листинге хаотический по определению, что не годится для
				рисунка.
			
			<dt>
				Name
			<dd>
				Сортировка по имени совместно с Unicode - большая и больная тема. Разберемся с ней позднее.
			
			<dt>
				Version
			<dd>
				Примитивное версионирование файлов в Unix. Некоторые сведения можно почерпнуть из 
				<a href="https://midnight-commander.org/ticket/1994">
				cистемы отслеживания ошибок проекта Midnight Commander</a>. Цифры на конце имени сделают рисунок 
				хуже, да и сортировка по версии не намного лучше сортировки по дате модификации, к примеру.

			<dt>
				Extension
			<dd>
				Расширения в Linux нам не сильно помогут. Дело в том, что расширения файлов - не "родная" концепция 
				Unix. И, в отличие от <a href="#illustration-1">файловых менеджеров для DOS</a>, в 
				<em>Midnight Commander</em> расширения отображаются не отдельно, а рядом с именем файла (то же самое 
				касается команды <em>ls</em>). Воздержимся от их использования.
			
			<dt>
				Size
			<dd>
				Отлично подойдет для файлов (что нам стоит напихать в них нулевые байты?). Но с директориями не 
				прокатит: их размер всегда равен 4096 байт.
			
			<dt>
				Modify time / Access time / Change time
			<dd>
				Их как нечего можно использовать для сортировки. Особенно если учесть, что <strong>Modify time</strong> 
				выводится <em>Midnight Commander</em>'ом в отдельной колонке (a комадна <em>ls</em> вообще не показывает
				время по-умолчанию). Вариантов тут много - даже точность в одну секунду дает фантастические результаты в 
				плане максимального количества одновременно сортируемых элементов.
			
			<dt>
				Inode
			<dd>
				Не подходят, поскольку их значения непредсказуемы.

			<dt>
				Executable first
			<dd>
				Не подходит ничуть, понятное дело.
				
			<dt>
				Case sensitive
			<dd>
				Cвязано с сортировкой по имени, но об это позже.
			
			<dt>
				Reverse
			<dd>
				Полезно, если только захочется перевернуть рисунок.
		</dl>
			
		<p>
			Как уже было сказано <a href="#note-about-sorting-by-name">выше</a>, сортировка по имени придаст рисунку 
			заметный плюс в плане его отображения без дополнительных настроек. А если еще устанавливать синхронно с 
			возрастающими именами дату модификации файла (и прочие атрибуты), то можно будет рисовать так, что как ни 
			сортируй листинг, он все равно будет рисунком (разве что перевернутым)! Заманчивая это идея задействовать 
			Unicode-пробелы (здесь и далее я имею ввиду "хорошие" пробелы)...  И, кроме сортировки, Unicode-пробелы 
			помогут поддерживать уникальность строк в рисунке (ведь коды пробелов разные)!
		
		<p>
			Можно поступить следующим образом: к началу каждой строки исходного ASCII-рисунка приклеить по 
			Unicode-пробелу в соответствии с порядковым номером строки, т.е. чтобы коды пробелов возрастали в ту же 
			сторону, куда растут номера строк в оригинальном рисунке. Если строк в оригинальном рисунке слишком много 
			(скажем, в нашем распоряжении 10 пробелов, а строк в рисунке 20), то можно подставлять пробелы парами. Тогда
			максимально возможное количество строк возрастает до 100 (10x10). А если и этого окажется мало, на помощь 
			придут комбинации из трех пробелов и т.д.
		
		<h2>Не тут-то было!</h2>
		
		<p>
			Все "можно" из предыдущего абзаца мигом превращаются в "нельзя" на практике. Дело в пресловутых локалях. Но 
			обо все по порядку.
			
		<p>
			Нарисуем превдографическую букву "А" (на самом деле возьмем ее из написанной ранее статьи
			<a href="http://flaz14.github.io/skype-extra-messaging/skype-extra-messaging-part-2.html">
			"Креативные" сообщения в Skype</a>). Заменим дефисы на пробелы (обычные, т.е. с ASCII-кодом 32) и получим
			простой ASCII-рисунок, приведенный в <a href="#listing-1">листинге 1</a>.
		
<h4 id="listing-1">Листинг 1 - простой ASCII-рисунок</h4>
<pre>
       
  ***  
 *   * 
 ***** 
 *   * 
 *   * 
       
</pre>		

		<p>
			Всего 7 строчек. Добавляем к каждой строке Unicode-пробелы из таблицы (в порядке возрастания их кодов) - и 
			дело в шляпе.
		
		<p>
			Для этого я подготовил 
			<a href="https://github.com/flaz14/flaz14.github.io/blob/master/directory-art/code/directoryart.py">
			демонстрационный скрипт</a> (он сделан на скорую руку). 

<h4 id="listing-2">Листинг 2 - реальная сортировка имен, содержащих Unicode-пробелы</h4>
<pre>
$ cat a.txt | ./directoryart.py 
/tmp/tmpvnwwm1ij


$ ls -1 /tmp/tmpvnwwm1ij
         
   *   * 
        
   *   * 
    ***  
   *   * 
   ***** 
</pre>	
		
		<p>
			Как видим, в <a href="#listing-2">листинге 2</a> строчки "поехали". И буква "А" стала непохожа сама на себя. 
			Что же пошло не так? На самом деле, все произошло, как нужно. С точки зрения текущей локали 
			(<code>en_US.UTF-8</code>) все Unicode-пробелы (за исключением, быть может, "обычного" пробела c кодом 32, 
			т.е. <code>U+0020</code>) - одинаковые символы. Это как если бы в Java 
			<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Comparator.html">Comparator</a> для каждой пары
			пробелов возвращал в результате сравнения 0. Это значит, что порядок файлов, имена которых начинаются с 
			Unicode-пробелов, не определен в листинге директории. Т.е. наличие/отсутствие пробелов ничего не меняет. 
			Проверим это: в исходном рисунке поставим цифры перед каждой строкой, как это показано в 
			<a href="#listing-3">листинге 3</a>.

<h4 id="listing-3">Листинг 3 - простой ASCII-рисунок с заранее пронумерованными строками</h4>
<pre>
1       
2  ***  
5 *   * 
3 ***** 
4 *   * 
9 *   * 
8       
</pre>
			
		<p>
			Запустим скрипт и увидим, что листинг получившейся директории принял 
			<a href="#listing-4">совершенно иной вид</a>. А именно: теперь элементы упорядочены в строгом соответствии с
			цифрами. Т.е. наличие/отсутствие Unicode-пробелов порядок строк не меняет.

<h4 id="listing-4">Листинг 4 - сортировка имен, содержащих, кроме пробелов, цифры</h4>		
<pre>
$ cat a_with_numbers.txt | ./directoryart.py 
/tmp/tmppfn4ghv4


$ ls -1 /tmp/tmppfn4ghv4
  1       
  2  ***  
  3 ***** 
  4 *   * 
  5 *   * 
  8      
  9 *   * 
</pre>
		
		<p>
			Вернемся к локалям. Unicode-пробелы все же учитываются при сортировке, но только в локали 
			<strong>C</strong>. Это простейшая локаль. Символы упорядочиваются согласно их кодам (подробности ищите в 
			замечательном ответе <a href="https://unix.stackexchange.com/a/87763/118991">What does “LC_ALL=C” do?</a>).
			Попробуем локаль <strong>C</strong> и получим <a href="#listing-5">листинг 5</a>.

<h4 id="listing-5">Листинг 5 - сортировка листинга директории по имени в локали C</h4>
<pre>
$ cat a.txt | ./directoryart.py 
/tmp/tmpcxvhw4km


$ export LC_ALL=C


$ ls -1 /tmp/tmpej5yabdy
 ??       
 ???  ***  
 ??? *   * 
 ??? ***** 
 ??? *   * 
 ??? *   * 
 ???      
</pre>

		<p>
			Как видим, в локали <strong>C</strong> порядок элементов - что надо. Правда, Unicode-пробелы воспринимаются 
			как чужеродные и заменяются знаком вопроса. Решить эту проблему можно с помощью ключа 
			<em>--show-control-chars</em>.

<h4 id="listing-6">Листинг 6 - корректное отображение Unicode-пробелов в локали C</h4>	
<pre>
$ ls -1 --show-control-chars /tmp/tmpej5yabdy
         
    ***  
   *   * 
   ***** 
   *   * 
   *   * 
        
</pre>		
		
		<p>
			Итак, идея упорядочивания элементов в каталоге по имени с помощью Unicode-пробелов с треском провалилась. В 
			принципе, она работает. Но красивый результат требует шаманства еще больше, чем в случае с сортировкой по 
			времени модификации файла. Можно посмотреть на сортировку по времени в <a href="#listing-7">листинге 7</a>.
			Всего один дополнительный ключ <em>-t</em> (он же <em>--sort=time</em>) потребуется.

<h4 id="listing-7">Листинг 7 - сортировка листинга каталога по времени </h4>		
<pre>
$ cat a.txt | ./directoryart.py 
/tmp/tmp3o7_qfoe


$ ls -1 -t /tmp/tmp3o7_qfoe
         
    ***  
   *   * 
   ***** 
   *   * 
   *   * 
        
</pre>
		
		<p>
			Придеться довольствоваться сортировкой по времени. К слову, можно реализовать скрипт так, чтобы он ставил не
			только упорядоченные метки времени, но и расширения и т.д. Но без порядка в именах это не имеет смысла.
		
		<h2>Маленькое утешение</h2>	
			
		<p>
			Попробуем наш скрипт на большом ASCII-рисунке. Например, на таком (взят с сайта 
			<a href="http://www.chris.com">www.chris.com</a>):

<h4 id="illustration-7">Рисунок 7 - большой ASCII-рисунок</h4>		
<p>
	<img 
	src="illustrations/Lauren-Michelle-Hill.png"
	width="640px"
	alt="скриншот Web-браузера с открытым в нем ASCII-рисунком">	
			
		<p>
			Возникает вопрос, как такую большую ASCII-картинку отобразить в терминале, чтобы она полностью поместилась 
			на экран и чтобы строки (а они получатся слишком длинными) не "съехали"? Все просто. В эмуляторе терминала 
			(у меня <a href="https://help.gnome.org/users/gnome-terminal/stable/">GNOME Terminal</a> версии 3.6.2)
			достаточно уменьшить шрифт, т.е. несколько раз нажать <kbd>Ctrl</kbd> + <kbd>-</kbd>. В чистом терминале это
			выглядит так:

<h4 id="illustration-8">Рисунок 8 - большой ASCII-рисунок, отображаемый в эмуляторе терминала</h4>
<p>
	<img 
	src="illustrations/Lauren-Michelle-Hill_gnome-terminal.png"
	width="676px"
	alt="скриншот эмулятора терминала, в который выведен листинг каталога">

		<p>
			Интересный момент, как же так получилось, что в именах файлов встречаются слэши, ведь они недопустимы в 
			Linux? Ответ простой: обычные слэши, которые используются в качестве разделителей элементов в пути к файлу, 
			были заменены на Unicode-слэш. А именно на т.н. <em>DIVISION SLASH</em>. Выглядит он точно так же, как и 
			обычный (по крайней мере, я различий не вижу, а может, это зависит от используемого в терминале шрифта...).
		
		<p>
			И наконец, посмотрим на ту же девушку в окне Midnight Commander'а. Для этого потребуется в настройках панели
			изменить сортировку с <em>Name</em> на <em>Modify time</em>, а также поставить крестик напротив 
			<em>Reverse</em> (странно, конечно, ведь в случае с <strong>ls</strong> опция <em>-t</em> не требовала 
			обратного порядка...).

<h4 id="illustration-9">Рисунок 9 - большой ASCII-рисунок, отображаемый в Midnight Commander'е</h4>
<p>
	<img 
	src="illustrations/Lauren-Michelle-Hill_mc.png"
	width="676px"
	alt="скриншот панели Midnight Commander'а c листингом каталога">

		<p>
			Начинания с Unicode-пробелами в деле рисования с помощью каталогов разбились вдребезги о суровую реальность.
			Как бы то ни было, пробелы пригодились, пусть даже они и не решили всех проблем. А прекрасные рисунки всегда
			остаются классными. Когда смотришь на  <i>Lauren Michelle Hill</i>, изображенную псевдографическими файлами 
			в окне Midnight Commander'а, жизнь кажется не такой уж бессмысленной.  

		<hr>

		<h1>
			<big>
				<a href="#" title="Перейти к началу страницы">&uarr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="http://validator.w3.org/check?uri=referer">
					<img src="http://www.w3.org/Icons/valid-html401" alt="Valid HTML 4.01 Strict" 
					height="31" width="88">
				</a>
			</big>
		</h1>
	</body>
</html>
