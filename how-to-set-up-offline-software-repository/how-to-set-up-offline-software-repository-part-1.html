<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Как сделать off-line репозиторий ПО для LinuxMint 17.1. Часть 1</title>
	</head>

	<body>
		<h1>
			<big>
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>

		<hr>

		<h1>
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-1.html">
				Как сделать off-line репозиторий ПО для LinuxMint 17.1. Часть 1
			</a>
		</h1>
		
		<h3>[2016, Декабрь]</h3>

		<h3>
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-2.html">
				Часть 2
			</a>
			|
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-3.html">
				Часть 3
			</a>
			|
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-4.html">
				Часть 4
			</a>			
			|
			<a href=
		"https://github.com/flaz14/flaz14.github.io/tree/master/how-to-set-up-offline-software-repository/code">
				Исходный код
			</a>
		</h3>

		<h2>What can I do?</h2>
		
		<p>
			Есть ли идеальный способ создания собственного репозитория ПО для использования в режиме off-line? Наверное, 
			нет. Каждый способ имеет свои достоинства и недостатки. Попробуем разобраться с ними:
			
		<p>
			<ol>
				<li>
					<h4>Использование <strong>apt-get</strong> для скачивания всех-всех пакетов.</h4>
						
					<p>
						Нам поможет опция <code>--download-only</code>. Т.о. все, что нужно сделать - пробежаться по 
						списку доступных пакетов и для каждого из них выполнить 
						<code>sudo apt-get --download-only install ...</code> 
						
					<p>
						Достоинства такого подхода: все получается естественным путем, автоматически проверяются 
						контрольные суммы и т.д. Основной же недостаток состоит в том, что <strong>apt-get</strong> 
						"видит" только пакеты, соответсвующие архитектуре системы, на которой он запущен. Т.е. если 
						скачивание производится из 32-битного дистрибутива, то для скачивания будут доступны только 
						пакеты для архитектуры <i>x86</i>. Кроме того, маленькие файлы россыпью скачиваются медленнее, 
						чем несколько больших из-за накладных расходов на поиск и "вычленение" отдельных пакетов из их 
						великого множества. 
						
					<p>
						Интересный вопрос - коллизии, которые могут возникнуть во время скачивания. Например, мы уже 
						скачали пакет <b>А</b>, затем он обновился в репозитории, заодно обновился пакет <b>Б</b>, 
						который нам еще предстоит скачать и который зависит от <b>А</b>. Затем мы скачали обновившийся в
						репозитории <b>Б</b>. Будут ли <b>А</b> и <b>Б</b> "стыковаться" друг с другом (ведь у нас на 
						локальном диске находится устаревшая версия <b>А</b>)? С вероятностью 99% будут. Потому что 
						мажорные версии пакетов выходят не так уж часто, и с сохранением обратной совместимости. Т.е. 
						разработчики <b>Б</b> используют обычно только проверенную временем функциональность <b>А</b>.
						
				<li>
					<h4>Торренты</h4>
					
					<p>
						Как было бы классно скачать раздачу с архивами пакетов для всех возможных архитектур вместе с 
						исходными кодами и т.д. Тем более, что в любом клиенте можно убрать галочки с ненужных файлов. 
						Клиент проверит контрольные суммы, и в любой момент можно приостановить закачку. А самое 
						главное - полное отсутствие коллизий. Потому что раздача - это файл(ы), запечатленный в 
						некоторый момент времени. К сожалению, официально ни сообщество Ubuntu, ни сообщество LinuxMint 
						торренты с архивами ПО не выкладывают (в отличие от образов установочных дисков). Толку же от 
						неофициальных архивов нету никакого. Дело не только в возможном наличии вирусов и т.п. мусора. 
						Сами архивы могут быть составлены из файлов, скачанных в течение длинного отрезка времени. А это
						повышает вероятность коллизий. В общем, качать софт с неофициальных сайтов - это как покупать 
						Audio CD, переписанный с MP3-файлов.
			
				<li>
					<h4>Скачивание ПО из официальных архивов вручную</h4>
						
					<p>
						Если взглянуть на 
<a href="https://github.com/flaz14/flaz14.github.io/blob/master/how-to-set-up-offline-software-repository/code/apt-get_update_sample.log">
						вывод команды <code>apt-get update</code>
</a>, 
						то можно увидеть серверы, с которых <strong>apt-get</strong> скачивает пакеты. Выделим
						неповторяющиеся ссылки на серверы с помощью скрипта 
<a href="https://github.com/flaz14/flaz14.github.io/blob/master/how-to-set-up-offline-software-repository/code/extract-http-links.sh">
						extract-http-links.sh
</a>:

<pre>
david $ ./extract-http-links.sh 
http://archive.canonical.com
http://archive.ubuntu.com
http://extra.linuxmint.com
http://packages.linuxmint.com
http://security.ubuntu.com
</pre>
					<p>					
						Если перейти по этим ссылкам, то можно заметить их сходство: все указывают на списки файлов или 
						что-нибудь в таком роде. О создании репозитория ПО для Ubuntu рассказано в 
						<a href="https://help.ubuntu.com/community/AptGet/Offline/Repository">документации</a>. Но 
						придется еще скачать ПО с <strong>linuxmint.com</strong> и <strong>canonical.com</strong>. 
						Кроме того, придется вручную проверять контрольные суммы и грамотно обрабатывать коллизии.
			</ol>
			
		<p>
			Вполне возможно, что для каждого из вышеперечисленых подходов уже есть готовые скрипты и даже программы, 
			которые делают все сами. Но мы сделаем вид, что ничего подобного нет. Изобретем велосипед!

		<h2>Приступим!</h2>

		<p>
			Перво-наперво, узнаем кодовое имя релиза. Например, так:
<pre>
david@athlonx2 / $ cat /etc/*release
DISTRIB_ID=LinuxMint
DISTRIB_RELEASE=17.1
DISTRIB_CODENAME=rebecca
DISTRIB_DESCRIPTION="Linux Mint 17.1 Rebecca"
NAME="Ubuntu"
VERSION="14.04.5 LTS, Trusty Tahr"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 14.04.5 LTS"
VERSION_ID="14.04"
...
</pre>

		<p>
			Т.о. кодовое имя релиза - <strong>Trusty Tahr</strong>, или просто <strong>Trusty</strong>.

		<p>
			Посмотрим на содержимое <a href="http://archive.ubuntu.com/ubuntu/dists/">архива ПО Ubuntu</a> с "высоты 
			птичьего полета" и увидим картину, изображенную на <a href="#illustration-1-1">рисунке 1.1.</a>

<h4 id="illustration-1-1">Рисунок 1.1 - общий вид архива ПО Ubuntu Trusty Tahr</h4>
<img src="illustrations/overall-folder-structure.png" width="320px">

		<p>
			Имена обведенных рамкой каталогов уже расшифрованы в 
			<a href="http://help.ubuntu.ru/wiki/%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9">
				документации по Ubuntu
			</a>.
			Приведем здесь выдержку, сделанную методом copy-and-paste:
			<ul>
				<li>
					<i>trusty</i> - пакеты на момент выхода релиза;
					
				<li>
					<i>trusty-security</i> - пакеты критических обновлений безопасности;
					
				<li>
					<i>trusty-updates</i> - пакеты обновления системы (т.е. более поздние версии ПО, вышедшие уже после 
					релиза);
					
				<li>
					<i>trusty-backports</i> - бэкпорты более новых версий некоторого ПО, которое доступно только в 
					нестабильных версиях Ubuntu;
					
				<li>
					<i>trusty-proposed</i> - пакеты, соответсвующие ПО, в котором исправлены ошибки (bug fix), но еще 
					не прошедшие тестирование.
			</ul>

		<p>
			В принципе, пакеты из <i>trusty-backports</i> и <i>trusty-proposed</i> нам не понадобятся (они не 
			используются при обновлении посредством <strong>apt-get</strong>). Но их мы тоже скачаем, на всякий случай.

		<p>
			Теперь заглянем внутрь 
			<a href="http://archive.ubuntu.com/ubuntu/dists/trusty/">
				каталога, содержащего пакеты на момент выхода релиза
			</a> (см. <a href="#illustration-1-2">рисунок 1.2</a>):
	
		<h4 id="illustration-1-2">Рисунок 1.2 - ПО на момент выхода релиза</h4>
		<img src="illustrations/folder-structure-of-release.png" width="480px">

		<p>
			Попробуем разобраться:
			
			<ol>
				<li>
					<p>
						<strong>Contents-amd64.gz</strong> и <strong>Contents-i386.gz</strong> содержат списки файлов, 
						из которых состоят двоичные пакеты (в распакованном виде) для архитектур <i>AMD64</i> и 
						<i>x86</i> соответственно. Выглядят эти списки таким образом:
<pre>
...
FILE                                                    LOCATION
bin/afio                                                    multiverse/utils/afio
bin/ash                                                     universe/shells/ash
bin/autopartition                                           admin/ubiquity
bin/autopartition-crypto                                    admin/ubiquity
bin/autopartition-loop                                      admin/ubiquity
bin/autopartition-lvm                                       admin/ubiquity
bin/bash                                                    shells/bash
bin/bash-static                                             universe/shells/bash-static
bin/block-attr                                              admin/ubiquity
bin/blockdev-keygen                                         admin/ubiquity
bin/blockdev-wipe                                           admin/ubiquity
...
</pre>

					<p>
						Т.е. все файлы перечислены в алфавитном порядке. В целом, это очень полезный список, т.к. имея 
						его	под рукой, несложно с помощью <code>grep</code> определить, какой файл какому пакету 
						принадлежит (о чем собственно и сказано в комментарии в начале файла). Так что однозначно будем 
						скачивать такие	списки.

				<li>		
					Файл <strong>Release</strong> поинтереснее. Он содержит контрольные суммы для архивов ПО. Вот 
					фрагмент файла:
<pre>
...
MD5Sum:
 ead1cbf42ed119c50bf3aab28b5b6351          8234934 main/binary-amd64/Packages
 52d605b4217be64f461751f233dd9a8f               96 main/binary-amd64/Release
 4c2ecc07c5b3859ee08bd41f788a5a79          1743009 main/binary-amd64/Packages.gz
 eb5ec6102dfe1dd632fda76e55a33f07          1350329 main/binary-amd64/Packages.bz2
 2f6aba238097579bbb4fe92e5bfa0858          7558784 main/binary-arm64/Packages
 5c1efe41ea46ec1a7505c8ed0e93a10d               96 main/binary-arm64/Release
...
</pre>

					Очень полезный файл. Он поможет в будущем для сверки контрольных сумм. Сверка не гарантирует на 
					100%, что скачанные архивы целые-невредимые, потому что сами контрольные суммы лежат в одном 
					каталоге с архивами. К тому же, как и архивы, суммы могут быть скачаны только по протоколу HTTP! 
					Хотя вряд ли произойдет "согласованное" искажение архивов и контрольных сумм, да и нехорошему 
					"человеку посередине" будет не так уж просто устроить подмену и того, и другого одновременно, так 
					что можно верить этим хэшам на 99%.

				<li>
					Файл <strong>Release.gpg</strong> содержит цифровую подпись - все понятно. Обязательно проверим.
					
				<li>
					<strong>main</strong>, <strong>multiverse</strong>, <strong>restricted</strong>, 
					<strong>restricted</strong> - о них сказано во все той же 
<a href="http://help.ubuntu.ru/wiki/%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9">
	документации по Ubuntu
</a>.
					Скопипастим немножко:
					<ul>
						<li>
							<i>main</i> - свободное ПО, официально поддерживаемое компанией Canonical;
							
						<li>
							<i>restricted</i> - проприетарное ПО (в основном - драйверы устройств), официально 
							поддерживаемое компанией Canonical;
							
						<li>
							<i>universe</i> - свободное ПО, официально не поддерживаемое компанией Canonical (но 
							поддерживаемое сообществом пользователей);
							
						<li>
							<i>multiverse</i> - проприетарное ПО, не поддерживаемое компанией Canonical.
					</ul>
					
					Будем качать и официальное, и неофициальное...
			</ol>
		
		<p>
			На <a href="#illustration-1-2">рисунке 1.2</a> можно заметить, что последнее изменение содержимого произошло
			в 2014 году, что соответствует фразе "на момент выхода релиза".
		

		<p>
			Заглянем в каталог <a href="http://archive.ubuntu.com/ubuntu/dists/trusty/main/">main</a>. И увидим кучу 
			папок, приведенную на <a href="#illustration-1-3">рисунке 1.3</a>:

		<h4 id="illustration-1-3">Рисунок 1.3 - структура архива официально поддерживаемого ПО</h4>
		<img src="illustrations/main-group-of-packages.png" width="480px">

		<p>
			Тут более-менее все ясно: одни каталоги соответсвуют различным архитектурам, другие имеют отношение к 
			интернационализации и локализации, исходным кодам и т.д. Зайдем в каталог 
			<a href="http://archive.ubuntu.com/ubuntu/dists/trusty/main/binary-i386/">binary-i386</a>, к примеру, и 
			увидим одни лишь файлы, как на <a href="#illustration-1-4">рисунке 1.4</a>:
			
		<h4>Рисунок 1.4 - "дно" архива ПО Ubuntu</h4>
		<img src="illustrations/bottom-of-the-archive-sea.png" width="600px">
			
		<p>
			Нужно скачать и <i>Packages.bz2</i>, и <i>Packages.gz</i>, и <i>Release</i>.
			
		<p>
			О реализации подвижных деталей велосипеда речь пойдет в 
<a href="http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-2.html">
			части 2.
</a>

		<hr>

		<h1>
			<big>
				<a href="#" title="Перейти к началу страницы">&uarr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>
	</body>
</html>
