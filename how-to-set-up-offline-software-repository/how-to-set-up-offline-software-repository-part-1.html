<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Как сделать off-line репозиторий ПО для LinuxMint 17.1. Часть 1</title>
	</head>

	<body>
		<h1>
			<big>
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>

		<hr>

		<h1>
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-1.html">
				Как сделать off-line репозиторий ПО для LinuxMint 17.1. Часть 1
			</a>
		</h1>
		
		<h3>[2016, Декабрь]</h3>

		<h3>
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-2.html">
				Часть 2
			</a>
			|
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-3.html">
				Часть 3
			</a>
			|
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-4.html">
				Часть 4
			</a>			
			|
			<a href=
		"https://github.com/flaz14/flaz14.github.io/tree/master/this_source_code_does_not_exist_yet">
				Исходный код
			</a>
		</h3>

		<h2>What can I do?</h2>
		
		<p>
			Есть ли идеальный способ создания собственного репозитория ПО для использования в режиме off-line? Наверное, 
			нет. Каждый способ имеет свои достоинства и недостатки. Попробуем разобраться с ними:
			
		<p>
			<ol>
				<li>
					<p>
						Использование <strong>apt-get</strong> для скачивания всех-всех пакетов. 
						
					<p>
						Нам поможет опция <code>--download-only</code>. Т.о. все, что нужно сделать - пробежаться по 
						списку доступных пакетов и для каждого из них выполнить 
						<code>sudo apt-get --download-only install ...</code> Достоинства такого подхода: все получается
						естественным путем, проверяются контрольные суммы и т.д. Основной же недостаток состоит в том, 
						что <strong>apt-get</strong> "видит" только пакеты, соответсвующие архитектуре системы, на
						которой он запущен. Т.е. если скачивание производится из 32-битного дистрибутива, то для 
						скачивания будут только пакеты для архитектуры <i>x86</i>. Кроме того, маленькие файлы россыпью
						скачиваются медленнее, чем несколько больших из-за накладных расходов на поиск и 
						"вычленение" каждого пакета из их великого множества. Особенно интересный вопрос - возможные 
						несоответствия, которые могут возникнуть во время скачивания. Например, мы уже скачали пакет 
						<b>А</b>, затем он обновился в репозитории, заодно обновился пакет <b>Б</b>, который нам еще 
						предстоит скачать и который зависит от <b>А</b>. Затем мы скачали обновившийся в репозитории 
						<b>Б</b>. Будут ли <b>А</b> и <b>Б</b> "стыковаться" друг с другом (ведь у нас на локальном 
						диске находится устаревшая версия <b>А</b>)? С вероятностью 99% будут. Потому что мажорные 
						версии пакетов выходят не так уж часто, и с сохранением обратной совместимости. Т.е. 
						разработчики <b>Б</b> используют обычно только проверенную временем функциональность 
						<b>А</b>. И нечасто несколько пакетов одновременно обновляются в репозитории.
						
				<li>
					<p>
						Торренты
					
					<p>
						Как было бы классно скачать раздачу с архивами пакетов для всех возможных архитектур вместе с 
						исходными кодами и т.д. Тем более, что в любом клиенте можно убрать галочки с ненужных файлов. 
						Контрольные суммы проверяются автоматически, в любой момент можно приостановить закачку. А самое
						главное - полное отсутствие коллизий. Потому что раздача - это файл(ы), запечатленный в 
						некоторый момент времени. К сожалению, официально ни сообщество Ubuntu, ни сообщество LinuxMint 
						торренты с архивами ПО не выкладывают (в отличие от образов установочных дисков). Толку от 
						скачивания неофициальных архивов нету никакого. Дело не только в возможном наличии вирусов и 
						т.п. мусора. Сами архивы могут быть скачаны	лишь бы как, а затем всего лишь оформлены в виде 
						раздачи. Это как покупать Audio CD, переписанный с MP3-файлов.
			
				<li>
					<p>
						Скачивание ПО из официальных архивов. 
						
					<p>
						Если взглянуть на 
<a href="https://github.com/flaz14/flaz14.github.io/blob/master/how-to-set-up-offline-software-repository/code/apt-get_update_sample.log">
						вывод команды apt-get update
</a>, 
						то можно увидеть серверы, с которых <strong>apt-get</strong> будет скачивать пакеты. Выделим
						ссылки на серверы с помощью скрипта <a href="link will be here">extract-http-links.sh</a>:
						
						!!!пока что тут ничего нет, нужно "допилить" скрипт
						
						Если перейти по этим ссылкам, то можно заметить общую черту: все они указывают на списки файлов 
						или что-нибудь в таком роде.
						
						Теперь выделим уникальные имена доменов из этих ссылок с помощью скрипта 
						
						Применительно к Ubuntu об этом рассказано
						в <a href="https://help.ubuntu.com/community/AptGet/Offline/Repository">документации</a>. Но тут
						придется постараться: самим проверять контрольные суммы и предотвращать коллизии.
			</ol>
			
		<p>
			Вполне возможно, что для каждого из вышеперечисленых подходов существуют скрипты и даже программы, которые 
			делают все сами. Но мы сделаем вид, что ничего подобного нет. И изобретем очередной велосипед. Кроме того, 
			LinuxMint требует особого внимания, поскольку использует, кроме репозиториев Ubuntu, свои собственные.

		<h2>Приступим!</h2>

		<p>
			Перво-наперво, узнаем кодовое имя релиза. Например, так:
<pre>
david@athlonx2 / $ cat /etc/*release
DISTRIB_ID=LinuxMint
DISTRIB_RELEASE=17.1
DISTRIB_CODENAME=rebecca
DISTRIB_DESCRIPTION="Linux Mint 17.1 Rebecca"
NAME="Ubuntu"
VERSION="14.04.5 LTS, Trusty Tahr"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 14.04.5 LTS"
VERSION_ID="14.04"
...
</pre>

		<p>
			Т.о. кодовое имя релиза - <strong>Trusty Tahr</strong>, или просто <strong>Trusty</strong>.

		<p>
			Посмотрим на содержимое <a href="http://archive.ubuntu.com/ubuntu/dists/">архива ПО Ubuntu</a> с 
			"высоты птичьего полета" и увидим картину, изображенную на <a href="#illustration-1-1">рисунке 1.1.</a>

<h4 id="illustration-1-1">Рисунок 1.1 - архив Ubuntu для релиза Trusty Tahr</h4>
<img src="illustrations/overall-folder-structure.png">

		<p>
			Имена выделенных каталогов уже расшифрованы в 
			<a href="http://help.ubuntu.ru/wiki/%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9">
				документации по Ubuntu
			</a>.
			Приведем здесь выдержку, сделанную методом copy-and-paste:
			<ul>
				<li>
					<i>trusty</i> - пакеты на момент выхода релиза
					
				<li>
					<i>trusty-security</i> - пакеты критических обновлений безопасности
					
				<li>
					<i>trusty-updates</i> - пакеты обновления системы (т.е. более поздние версии ПО, вышедшие уже после 
					релиза)
					
				<li>
					<i>trusty-backports</i> - бэкпорты более новых версий некоторого ПО, которое доступно только в 
					нестабильных версиях Ubuntu
					
				<li>
					<i>trusty-proposed</i> - пакеты, соответсвующие ПО, в котором исправлены ошибки (bug fix), но еще 
					не прошедшие тестирование
			</ul>

		<p>
			Пакеты из <i>trusty-backports</i> и <i>trusty-proposed</i> нам не понадобятся (они не используются при 
			обновлении посредством <strong>apt-get</strong>).

		<p>
			Теперь заглянем внутрь 
			<a href="http://archive.ubuntu.com/ubuntu/dists/trusty/">
				каталога, содержащего пакеты на момент выхода релиза
			</a> (см. рисунок 1.2):
	
		<h4 id="#illustration-1-2">Рисунок 1.2 - виды пакетов на момент выхода релиза</h4>
		<img src="illustrations/folder-structure-of-release.png">

		<p>
			Попробуем разобраться:
			
			<ol>
				<li>
					<strong>Contents-amd64.gz</strong> и <strong>Contents-i386.gz</strong> содержат списки файлов, из 
					которых состоят двоичных пакеты (в распакованном виде) для архитектур <i>x86</i> и <i>AMD64</i>
					соответственно. Выглядит это список таким образом:
<pre>
...
FILE                                                    LOCATION
bin/afio                                                    multiverse/utils/afio
bin/ash                                                     universe/shells/ash
bin/autopartition                                           admin/ubiquity
bin/autopartition-crypto                                    admin/ubiquity
bin/autopartition-loop                                      admin/ubiquity
bin/autopartition-lvm                                       admin/ubiquity
bin/bash                                                    shells/bash
bin/bash-static                                             universe/shells/bash-static
bin/block-attr                                              admin/ubiquity
bin/blockdev-keygen                                         admin/ubiquity
bin/blockdev-wipe                                           admin/ubiquity
...
</pre>

					Т.е. все файлы перечислены в алфавитном порядке. В целом, это очень полезный список, т.к. имея его
					под рукой, несложно с помощью <code>grep</code> определить, какой файл какому пакеты принадлежит (о 
					чем собственно и сказано в комментарии в начале файла). Так что однозначно будем скачивать такие
					списки.

				<li>		
					Файл <strong>Release</strong> поинтереснее. Он содержит контрольные суммы для архивов ПО. Вот 
					фрагмент файла:
<pre>
...
MD5Sum:
 ead1cbf42ed119c50bf3aab28b5b6351          8234934 main/binary-amd64/Packages
 52d605b4217be64f461751f233dd9a8f               96 main/binary-amd64/Release
 4c2ecc07c5b3859ee08bd41f788a5a79          1743009 main/binary-amd64/Packages.gz
 eb5ec6102dfe1dd632fda76e55a33f07          1350329 main/binary-amd64/Packages.bz2
 2f6aba238097579bbb4fe92e5bfa0858          7558784 main/binary-arm64/Packages
 5c1efe41ea46ec1a7505c8ed0e93a10d               96 main/binary-arm64/Release
...
</pre>

					Очень полезный файл. Он поможет в будущем для сверки контрольных сумм. Сверка не гарантирует на 
					100%, что скачанные архивы целые-невредимые, потому что сами контрольные суммы лежат в одном 
					каталоге с архивами, и к тому же, как и архивы, могут быть скачаны только по протоколу HTTP! Хотя 
					вряд ли произойдет "согласованное" искажение архивов и контрольных сумм, да и нехорошему "человеку 
					посередине" будет не так уж просто устроить подмену и того, и другого, так что можно верить этим 
					хэшам на 99%.

				<li>
					Файл <strong>Release.gpg</strong> содержит цифровую подпись - все понятно. Обязательно проверим.
					
				<li>
					<strong>main</strong>, <strong>multiverse</strong>, <strong>restricted</strong>, 
					<strong>restricted</strong> - о них сказано во все той же 
<a href="http://help.ubuntu.ru/wiki/%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9">
	документации по Ubuntu
</a>.
					Скопипастим немножко:
					<ul>
						<li>
							<i>main</i> - свободное ПО, официально поддерживаемое компанией Canonical
							
						<li>
							<i>restricted</i> - проприетарное ПО (в основном - драйверы устройств), официально 
							поддерживаемое компанией Canonical
							
						<li>
							<i>universe</i> - свободное ПО, официально не поддерживаемое компанией Canonical (но 
							поддерживаемое сообществом пользователей)
							
						<li>
							<i>multiverse</i> - проприетарное ПО, не поддерживаемое компанией Canonical
					</ul>
					
					Будем качать все: и официальное, и неофициальное, и т.д.
			</ol>

		<p>
			Заглянем в каталог <a href="http://archive.ubuntu.com/ubuntu/dists/trusty/main/">main</a>. И увидим кучу 
			папок, приведенную на рисунке 1.3:

		<h4>Рисунок 1.3 - структура архива официально поддерживаемого ПО</h4>
		<img src="illustrations/main-group-of-packages.png">

		<p>
			Тут более-менее все ясно: одни каталоги соответсвуют различным архитектурам, другие имеют отношение к 
			интернационализации и локализации, исходным кодам и т.д. Если зайти в каталог <i>binary-i386</i> к примеру, 
			то увидим одни лишь файлы (см. рисунок 1.4):
			
		<h4>Рисунок 1.4 - файлы архивов</h4>	
		<img src="illustrations/bottom-of-the-archive-sea.png">
			
		<p>
			Будем скачивать их все. О деталях реализации речь пойдет в части 2.

        <p>
			__________
			<ol>
				<li id="footnote-1-bottom">
					<p>
						<a href="#footnote-1-top" title="Перейти к основному тексту">&uarr;</a> 
						Слово "диск" не совсем уместно. Правильнее было бы сказать "том". 

				<li id="footnote-2-bottom">
					<p>
						<a href="#footnote-2-top" title="Перейти к основному тексту">&uarr;</a> 
						Я так и не разобрался, что все это значит: <i>udisks</i>, <i>GVfs</i>, 
			</ol>

		<hr>

		<h1>
			<big>
				<a href="#" title="Перейти к началу страницы">&uarr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>
	</body>
</html>
