<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Как сделать off-line репозиторий ПО для LinuxMint 17.1. Часть 1</title>
	</head>

	<body>
		<h1>
			<big>
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>

		<hr>

		<h1>
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-1.html">
				Как сделать off-line репозиторий ПО для LinuxMint 17.1. Часть 1
			</a>
		</h1>
		
		<h3>[2016, Декабрь]</h3>

		<h3>
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-2.html">
				Часть 2
			</a>
			|
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-3.html">
				Часть 3
			</a>
			|
			<a href=
		"http://flaz14.github.io/how-to-set-up-offline-software-repository/how-to-set-up-offline-software-repository-part-4.html">
				Часть 4
			</a>			
			|
			<a href=
		"https://github.com/flaz14/flaz14.github.io/tree/master/this_source_code_does_not_exist_yet">
				Исходный код
			</a>
		</h3>

		<h2>What can I do?</h2>
		
		<p>
			Есть ли идеальный способ создания собственного репозитория ПО для использования в режиме off-line? Наверное, 
			нет. Каждый способ имеет свои достоинства и недостатки. Попробуем разобраться с ними:
			
		<p>
			<ol>
				<li>
					<p>
						Использование <strong>apt-get</strong> для скачивания всех-всех пакетов. 
						
					<p>
						Нам поможет опция <code>--download-only</code>. Т.о. все, что нужно сделать - пробежаться по списку 
						всех доступных пакетов и для каждого из них выполнить <code>sudo apt-get --download-only install ...</code> 
						Достоинства такого подхода: все получается естественным путем, проверяются контрольные суммы и т.д.
						Основной же недостаток состоит в том, что <strong>apt-get</strong> "видит" только пакеты, соответсвующие архитектуре системы, на
						которой он запущен. Т.е. если скачивание производится из 32-битного дистрибутива, то в будут доступны для скачивания
						только пакеты для архитектуры <i>x86</i>. Кроме того, множество маленьких файлов скачиваются медленнее, чем 
						несколько больших файлов из-за накладных расходов на поиск и "вычленение" каждого пакета из их великого 
						множества. Особенно интересный вопрос - возможные несоответствия, которые могут возникнуть во время 
						скачивания. Например, мы уже скачали пакет <b>А</b>, затем он обновился в репозитории, заодно обновился  
						пакет <b>Б</b>, который нам еще предстоит скачать и который зависит от <b>А</b>. Затем мы скачали 
						обновившийся в репозитории <b>Б</b>. Будут ли <b>А</b> и <b>Б</b>
						ли они "стыковаться" друг с другом (ведь у нас на локальном диске находится устаревшая версия <b>А</b>)
						С вероятностью 99% - будут. Потому что мажорные версии пакетов выходят не так уж 
						часто, с сохранением обратной совместимости. Т.е. разработчики <b>Б</b> используют обычно только проверенную
						временем функциональность <code>А</code>. И нечасто несколько пакетов одновременно обновляются в репозитории.
						
				<li>
					Второй способ - это торренты. Как было бы классно скачать раздачу со архивами пакетов для всех возможных архитектур, 
					вместе с иходными кодами и т.д. Тем более, что в любом клиенте можно убрать галочки с ненужных файлов. 
					Контрольные суммы проверяются торрент-клиентом, в любой момент можно приостановить закачку. А самое главное -
					это полное отсутствие возможных коллизий. Потому что торрент - это файл, запечатленный в некоторый момент времени.
					Так что скачивае через торрент - идеальный
					вариант, по-моему. К сожалению, официально ни сообщество Ubuntu, ни сообщество LinuxMint такой ерундой не
					занимаются (но образы установочных дисков доступны в том числе через торренты). А толку от скачивания неофициальных
					архивов нету никакого. Дело не только в возможном наличии вирусов и т.п. мусора. Сами архивы могут быть скачаны
					лишь бы как, а затем всего лишь оформлены в виде торрент-раздачи. Это как покупать пиратский Audio CD, 
					переписанный с MP3-файлов.
			
				<li>
					Третий способ - скачать архивы из официального источника. Применительно к Ubuntu об этом сказано 
					в <a href="https://help.ubuntu.com/community/AptGet/Offline/Repository">документации</a>. Тут уж придется 
					постараться: самим проверять контрольные суммы и предотвращать коллизии.
			
		<p>
			Вполне возможно, что для всех вышеперечисленых подход существуют скрипты и даже программы, которые делают все
			сами. Но мы сделаем вид, что ничего подобного нет. И изобретем очередной велосипед. Кроме того, LinuxMint 
			требует особого подхода, поскольку использует, кроме репозиториев Ubuntu, собственные репозитории.
			
			</ol>

		<h2>Приступим!</h2>

		<p>
			Перво-наперво, узнаем кодовое имя релиза. Например, так:

<pre>
david@athlonx2 / $ cat /etc/*release
DISTRIB_ID=LinuxMint
DISTRIB_RELEASE=17.1
DISTRIB_CODENAME=rebecca
DISTRIB_DESCRIPTION="Linux Mint 17.1 Rebecca"
NAME="Ubuntu"
VERSION="14.04.5 LTS, Trusty Tahr"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 14.04.5 LTS"
VERSION_ID="14.04"
...
</pre>

Т.о. кодовое имя релиза - <strong>Trusty Tahr</strong>, или просто <strong>Trusty</strong>.

Посмотрим на содержимое  
<a href="http://archive.ubuntu.com/ubuntu/dists/">архива ПО Ubuntu</a> с "высоты птичьего полета" и увидим картину, 
изображенную на рисунке 1.1.

Рисунок 1.1 - Архив Ubuntu релиза Trusty Tahr
<img src="illustrations/overall-folder-structure.png">

Назначение выделенных каталогов уже описано в 
<a href="http://help.ubuntu.ru/wiki/%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9">документации по Ubuntu</a>.
Приведем здесь краткую выдержку, сделанную методом copy-and-paste:

<ul>
	<li>
		<i>trusty</i> - это пакеты на момент выхода релиза
		<i>trusty-security</i> - пакеты критических обновлений безопасности
		<i>trusty-updates</i> - пакеты обновления системы (т.е. более поздние версии ПО, вышедшие уже после релиза)
		<i>trusty-backports</i> - бэкпорты более новых версий некоторого ПО, которое доступно только в нестабильных версиях Ubuntu.
</ul>    
    
Раз уж мы делаем off-line репозиторий, нам понадобятся пакеты всех категорий. 

Заглянем внутрь <a href="http://archive.ubuntu.com/ubuntu/dists/trusty/">каталога, содержащего пакеты на момент выхода релиза</a>:

<img src="illustrations/folder-structure-of-release.png">

1)
<i>Contents-amd64.gz</i> и <i>Contents-i386.gz</i> содержат списки файлов двоичных пакетов для архитектур x86 и AMD64 
соответственно. Выглядит это список таким образом (на примере <i>Contents-i386.gz</i>):

<pre>
...
FILE                                                    LOCATION
bin/afio                                                    multiverse/utils/afio
bin/ash                                                     universe/shells/ash
bin/autopartition                                           admin/ubiquity
bin/autopartition-crypto                                    admin/ubiquity
bin/autopartition-loop                                      admin/ubiquity
bin/autopartition-lvm                                       admin/ubiquity
bin/bash                                                    shells/bash
bin/bash-static                                             universe/shells/bash-static
bin/block-attr                                              admin/ubiquity
bin/blockdev-keygen                                         admin/ubiquity
bin/blockdev-wipe                                           admin/ubiquity
...
</pre>

Т.е. все файлы перечислены в алфавитном порядке. В целом, это очень полезный список, т.к. имея такой список под рукой, 
достаточно запустить grep для определения соответствующего файлу пакета (о чем собственно и сказано в комментарии в начале
файла). Так что однозначно будем скачивать эти списки.

2)
Файл <strong>Release</strong> поинтереснее. Он содержит контрольные суммы для архивов ПО. Вот фрагмент файла:

<pre>
...
MD5Sum:
 ead1cbf42ed119c50bf3aab28b5b6351          8234934 main/binary-amd64/Packages
 52d605b4217be64f461751f233dd9a8f               96 main/binary-amd64/Release
 4c2ecc07c5b3859ee08bd41f788a5a79          1743009 main/binary-amd64/Packages.gz
 eb5ec6102dfe1dd632fda76e55a33f07          1350329 main/binary-amd64/Packages.bz2
 2f6aba238097579bbb4fe92e5bfa0858          7558784 main/binary-arm64/Packages
 5c1efe41ea46ec1a7505c8ed0e93a10d               96 main/binary-arm64/Release
...
</pre>

Очень полезный файл. Понадобится в будущем для сверки контрольных сумм. Сверка не гарантирует на 100%, что скачанные архивы 
целые-невредимые, потому что сами контрольные суммы лежат в одном каталоге с архивами, и к тому же, как и архивы, могут быть
скачаны только по протоколу HTTP! Хотя вряд ли произойдет "согласованное" искажение архивов и контрольных сумм, да и нехорошему
"человеку посередине" будет не так уж просто устроить подмену и того, и другого, так что можно полагаться на эти суммы на 99%.


3) 
<i>Release.gpg</i> - файл содержит цифровую подпись - все понятно. Обязательно проверим.

4)
main, 	multiverse, restricted, restricted - о них сказано во все той же 
<a href="http://help.ubuntu.ru/wiki/%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9">документации по Ubuntu</a>. 
Скопипастим немножко:

    main - свободное ПО, официально поддерживаемое компанией Canonical.
    restricted - проприетарное ПО (в основном - драйверы устройств), официально поддерживаемое компанией Canonical.
    universe - свободное ПО, официально не поддерживаемое компанией Canonical (но поддерживаемое сообществом пользователей).
    multiverse - проприетарное ПО, не поддерживаемое компанией Canonical.

Берем все-все-все!





----------------

Заглянем в каталог <a href="http://archive.ubuntu.com/ubuntu/dists/trusty/main/">main</a>. 

И увидим кучу файлов, приведенную на рисунке ...

<img src="illustrations/main-group-of-packages.png">

Тут более-менее все ясно: каталоги соответсвуют различным архитектурам, другие имеют отношение к интернационалиции и локализации, 
исходным кодам и т.д. и т.п.  В принципе, если зайти в каталог <i>binary-i386</i> к примеру, то увидим одни лишь файлы. 
Вот их и будем скачивать.

<img src="illustrations/bottom-of-the-archive-sea.png">

-------------------------------

Пишем скрипт, который все автоматизирует (часть 2)












		<p>
			В Linux Mint Cinnamon в качестве файлового менеджера по-умолчанию установлен 
			<a href="https://github.com/linuxmint/nemo">Nemo</a>. По-моему, это очень хорошая программа: 
			быстрая и в меру функциальная. Но есть в ней один недостаток: Nemo всегда отображает 
			несмонтированные диски <sup id="footnote-1-top"><a href="#footnote-1-bottom">[1]</a></sup>. 
			часть 2</a>.

        <p>
			__________
			<ol>
				<li id="footnote-1-bottom">
					<p>
						<a href="#footnote-1-top" title="Перейти к основному тексту">&uarr;</a> 
						Слово "диск" не совсем уместно. Правильнее было бы сказать "том". Том 
						объединить в том с помощью LVM.

				<li id="footnote-2-bottom">
					<p>
						<a href="#footnote-2-top" title="Перейти к основному тексту">&uarr;</a> 
						Я так и не разобрался, что все это значит: <i>udisks</i>, <i>GVfs</i>, 
			</ol>

		<hr>

		<h1>
			<big>
				<a href="#" title="Перейти к началу страницы">&uarr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>
	</body>
</html>
