<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Три способа вычисления факториала на Java</title>
	</head>

	<body>
		<h1>
			<big>
				<a href="/#java-factorial" title="Перейти к оглавлению">&larr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>

		<hr>

		<h1>
			<a href="http://flaz14.github.io/java-factorial/java-factorial.html">
				Три способа вычисления факториала на Java
			</a>
		</h1>
		
		<h3>[2018, Март]</h3>
		
		<h3>
			<a href="ссылка">Исходный код</a>
		</h3>

		<h2>Hello, World!</h2>

		<p>
			Задача на вычисление факториала - это что-то вроде "Hello, World!", только из мира математики. Есть три способа
			ее решения на Java: рекурсия, цикл и... снова рекурсия. 
			
		<p>
			В примерах нет никаких проверок на отрицательные значения,
			нуль, выход за диапазон типа <code>int</code>. Но это не так важно для этой ламерской заметки.
		
		<h2>Рекурсия</h2>	
		
		<p>
			Тут все просто: этот способ все уже тыщу раз видели.

<h4 id="#listing-1">Листинг 1 - вычисление факториала рекурсивным способом</h4>
<code>
public class FactorialRecursion {
	public static void main(String ignored[]) {
		System.out.println(
			String.format("%3s: %15s\n", "n", "factorial(n)") + 
			String.format("%3d: %15d\n", 1, factorial(1)) + 
			String.format("%3d: %15d\n", 2, factorial(2)) +
			String.format("%3d: %15d\n", 3, factorial(3)) + 
			String.format("%3d: %15d\n", 4, factorial(4)) + 
			String.format("%3d: %15d\n", 5, factorial(5)) + 
			""
		);
	}
	
	private static int factorial(int n) {
		if (n == 1) return 1;
		return n * factorial(n - 1);
	}
}
</code>
			
		<p>
			Запустим и получим:

<code>
$ javac FactorialRecursion.java && java FactorialRecursion
  n:    factorial(n)
  1:               1
  2:               2
  3:               6
  4:              24
  5:             120
</code>

		<h2>Цикл</h2>
		
		<p>
			Использование цикла не намного сложнее рекурсии. А может, даже проще для восприятия.
			
<h4 id="listing-2">Листинг 2 - вычисление факториала с помощью цикла</h4>
<code>
public class FactorialLoop {
	public static void main(String ignored[]) {
		System.out.println(
			String.format("%3s: %15s\n", "n", "factorial(n)") + 
			String.format("%3d: %15d\n", 1, factorial(1)) + 
			String.format("%3d: %15d\n", 2, factorial(2)) +
			String.format("%3d: %15d\n", 3, factorial(3)) + 
			String.format("%3d: %15d\n", 4, factorial(4)) + 
			String.format("%3d: %15d\n", 5, factorial(5)) + 
			""
		);
	}
	
	private static int factorial(int n) {
		int result = 1;
		for(int i = 1; i <=n; i++) {
			result *= i;
		}
		return result;
	}
}
</code>

		<p>
			Программа напечатает то же, что и предыдущая:
<code>
$ javac FactorialLoop.java && java FactorialLoop 
  n:    factorial(n)
  1:               1
  2:               2
  3:               6
  4:              24
  5:             120
</code>

		<h2>Снова рекурсия!</h2>
		
		<p>
			Возможно, в JDK есть классы, которые позволяют "прятать" рекурсию. Т.е. предоставляют удобный интерфейс в
			декларативном стиле. То же самое наверняка можно сделать с помощью потоков Java 8. Но есть и более хардкорный способ.
			
		<p>
			Конструкция try-with-resources (далее по тексту TWR) - именно то, что нужно. Ведь если в метод <code>close()</code> ресурса поместить
			блок <em>try</em>, в котором инициализируется ресурс того же класса, то при неявном вызове первого <code>close()</code>, 
			создастся еще один ресурс, который при закрытии создаст еще один и т.д. Т.о. рекурсия у нас есть.
			
		<p>
			К сожалению, этого недостаточно. Суть рекурсии в том, что из нее можно вернуть значение. Именно эта особенность и 
			позволяет писать код вроде <code>return n * factorial(n - 1)</code>. Но из метода <code>close()</code> вернуть значение
			нельзя. Обратиться к переменной ресурса после его автоматического закрытия тоже не получится, т.е. нельзя в блоке
			<em>finally</em> ссылаться на 
			на переменную, определенную в TWR. Так что ничего не остается, как использовать массив из одного элемента, чтобы 
			вернуть результат вычисления во внешний мир. 
			
		<p>
			Так что "чистой" рекурсии добиться сложно. Получается смесь рекурсии
			и цикла: методы <code>close()</code> вызываются рекурсивно, но внутри этих методов происходит последовательное умножение
			на n - 1 (первоначальное значение в массиве-оболочке равно единице), как в цикле.
			
<h4 id="listing-3">Листинг 3 - вычисление факториала с помощью TWR</h4>
<code>
public class FactorialTwr {
	public static void main(String ignored[]) {
		System.out.println(
			String.format("%3s: %15s\n", "n", "factorial(n)") + 
			String.format("%3d: %15d\n", 1, factorial(1)) + 
			String.format("%3d: %15d\n", 2, factorial(2)) +
			String.format("%3d: %15d\n", 3, factorial(3)) + 
			String.format("%3d: %15d\n", 4, factorial(4)) + 
			String.format("%3d: %15d\n", 5, factorial(5)) + 
			""
		);
	}
	
	private static int factorial(int n) {
		int[] resultPlaceholder = new int[] {1};
		try (FactorialAutoCloseable calculator = new FactorialAutoCloseable(n, resultPlaceholder)) { }
		return resultPlaceholder[0];
	}
	
	private static class FactorialAutoCloseable implements AutoCloseable {
		private int n;
		private int[] resultPlaceholder;
		
		public FactorialAutoCloseable(int n, int[] resultPlaceholder) {
			this.n = n;
			this.resultPlaceholder = resultPlaceholder;
		}
		
		@Override
		public void close() {
			if (n == 1) return;
			resultPlaceholder[0] *= n; 
			try(FactorialAutoCloseable calculator = new FactorialAutoCloseable(n - 1, resultPlaceholder)) { } 
		}
	}
}
</code>

		<p>
			Запустим и убедимся, что факториал вычисляется правильно:

<code>
$ javac FactorialTwr.java && java FactorialTwr 
  n:    factorial(n)
  1:               1
  2:               2
  3:               6
  4:              24
  5:             120
</code>

		<h2>Good bye, World!</h2>
		
		<p>
			Практического смысла в использовании TWR для рекурсивных вычислений нет. Но все равно интересно использовать 
			языковые конструкции не по назначению. Java - не такой уж скучный язык программирования, каким кажется на
			первый взгляд.	
		
		<hr>

		<h1>
			<big>
				<a href="#" title="Перейти к началу страницы">&uarr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="http://validator.w3.org/check?uri=referer">
					<img src="http://www.w3.org/Icons/valid-html401" alt="Valid HTML 4.01 Strict" 
					height="31" width="88">
				</a>
			</big>
		</h1>
	</body>
</html>
