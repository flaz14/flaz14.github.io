<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Несмонтированные диски - с глаз долой. Часть 3</title>
	</head>

	<body>
		<h1>
			<big>
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>

		<hr>

		<h1>
			<a href=
		"http://flaz14.github.io/how-to-hide-non-mounted-drives/how-to-hide-non-mounted-drives-part-3.html">
				Несмонтированные диски - с глаз долой. Часть 3
			</a>
		</h1>

		<h2>Проверяем ограничения</h2>

		<p>
			Кроме самого hook'а я подготовил тестовую программу, которая ведет себя так же, как и Nemo. 
			Исходные тексты находятся в
			<a href="http://flaz14.github.io/how-to-hide-non-mounted-drives/code"> том же каталоге, что и 
			сама статья</a> (или
<a href="https://github.com/flaz14/flaz14.github.io/tree/master/how-to-hide-non-mounted-drives/code">см. Github</a>.
			Для начала разберемся с ограничениями, о которых говорилось в  
<a href="http://flaz14.github.io/how-to-hide-non-mounted-drives/how-to-hide-non-mounted-drives-part-2.html">части 2
			</a>. 

		<p>
			Воспроизведем ситуацию, описанную в <a 
href="http://flaz14.github.io/how-to-hide-non-mounted-drives/how-to-hide-non-mounted-drives-part-1.html#illustration-1-
1">части 1</a>. 
			Итак, подключим флешку, смонтируем диск с меткой <i>8_ext</i> и оставим несмонтированным диск с 
			меткой <i>8_ntfs</i>. 
			
		<p>
			Запустим тестовую программу:
<pre>
david@athlonx2 ~/Projects/flaz14.github.io/how-to-hide-non-mounted-drives/code $ make test
./application

Hi! I'm sample application!

+ /dev/sdb2 [8_ext]
- /dev/sdb1 [8_ntfs]

Bye!
</pre>
			Как видно из вывода, Nemo "видит" смонтированный диск с меткой <i>8_ext</i> и несмонтированный 
			диск с меткой <i>8_ntfs</i>.
			
		<p>
			Теперь запустим тестовую программу с hook'ом:
			
<pre>
david@athlonx2 ~/Projects/flaz14.github.io/how-to-hide-non-mounted-drives/code $ make test-hook
gcc -Wall -g -shared -ldl -fPIC `pkg-config --cflags gtk+-3.0` libnemohook.c -o libnemohook.so `pkg-config --libs 
gtk+-3.0`
LD_PRELOAD=./libnemohook.so ./application

Hi! I'm sample application!

>
    /dev/sda
<
>
    /dev/sr0
<
>
    /dev/sdb
<
+ /dev/sdb2 [8_ext]

Bye!
</pre>
			
		Итак, 
<pre>
>
    /dev/...
<
</pre>
		означает, что hook перехватил обращение к функции <code>g_drive_get_volumes()</code>. Так, первым 
		физическим диском, тома на котром попытался бы получить Nemo, является 
		<code>/dev/sda</code>. На это диске не нашлось томов, поскольку <code>g_drive_get_volumes()</code> 
		покажет только те тома, которых нет в <code>/etc/fstab</code>). Далее, для физического диска 
		<code>/dev/sr0</code> тоже не нашлось дисков (перед запуском тестовой программы в приводе оптических 
		дисков было пусто). А вот на физическом диске <code>/dev/sdb</code> нашелся один только один том. 
		Сравним результаты:
		<ul>
			<li>
				Без hook'а:
<pre>
+ /dev/sdb2 [8_ext]
- /dev/sdb1 [8_ntfs]
</pre>
				
				
			
			<li>
				C hook'ом:
<pre>
+ /dev/sdb2 [8_ext]
</pre>
		</ul>
		
		Как видно, несмонтированный раздел куда-то пропал. Именно этого мы и добивались.
		

		<h2>Собираем костыль воедино</h2>
		
		<p>
			Теперь пришло время сменить оригинальный Nemo на костыль. Чтобы "костыльный" Nemo запускался из 
			терминала, достаточно создать скрипт с именем <code>nemo</code> (скрипт будет устанавливать 
			<code>LD_PRELOAD</code>) и добавить путь к этому скрипту в переменную окружения PATH (самый 
			простой способ - поместить скрипт в <code>~/bin</code>). Но будет, если попытаться запустить 
			Nemo из стартового меню Cinnamon? Или с помощью горячей клавиши на мультимедийной клавиатуре?
			Я попробовал все варианты: способ с переменной окружения <code>PATH</code> работает всегда. Так 
			что установим костыль:			
<pre>
david@athlonx2 ~/Projects/flaz14.github.io/how-to-hide-non-mounted-drives/code $ make install
gcc -Wall -g -shared -ldl -fPIC `pkg-config --cflags gtk+-3.0` libnemohook.c -o libnemohook.so `pkg-config --libs 
gtk+-3.0`
cp ./libnemohook.so ~/bin/libnemohook.so
chmod 500 ~/bin/libnemohook.so
cp ./nemo ~/bin/nemo
chmod 500 ~/bin/nemo
</pre>
	
			Как видим, скрипт-обертка (именно он подсовывает hook) и собственно hook размещаются в каталоге 
			<code>~/bin/</code>. Чтобы убрать костыль, достаточно набрать <code>make uninstall</code> (или 
			же удалить файлы вручную).
		
			
		<h2>Тестируем костыль</h2>
		
		<p>
			Возьмем все ту же флешку с двумя разделами: <i>8_ext</i> и <i>8_ntfs</i>: <i>8_ext</i> оставим
			смонтированным, а <i>8_ntfs</i> размонтируем. Запустим оригинальную версию Nemo 
			(нужно напрямую вызвать <code>/usr/bin/nemo</code> из командной строки). Увидим картинку, уже 
			приводившуюся в 
<a 
href="http://flaz14.github.io/how-to-hide-non-mounted-drives/how-to-hide-non-mounted-drives-part-1.html#illustration-1-
1">части 1<a>:

                <h4>
                        <a id="illustration-3-1">
                                Рисунок 3.1 - пример отображения несмонтированного диска на боковой панели Nemo
                        </a>
                </h4>
                
                <img alt="Пример отображения несмонтированного диска на боковой панели Nemo" 
                src="illustrations/nemo-sidebar-with-unmounted-drive-visible.png" width="240px">

		<p>
			Теперь запустим Nemo с костылем (как уже говорилось выше, для этого не нужно дополнительных 
			усилий, достаточно нажать на соответствующую кнопку в стартовом меню) и увидим все то же самое, 
			только без <i>8_ntfs</i> на боковой панели, что проиллюстрировано на рисунке 3.2:

                <h4>
                        <a id="illustration-3-2">
                                Рисунок 3.2 - несмонтировый диск не виден на боковой панели Nemo благодаря hook'у
                        </a>
                </h4>
			
			
                <img alt="Несмонтированный диск не отображается на боковой панели Nemo при благодаря hook'у" 
                src="illustrations/nemo-sidebar-without-unmounted-drive-visible.png" width="240px">

                <p>
		Как видим, костыль работает <sup id="footnote-1-top"><a href="#footnote-1-bottom">[1]</a></sup>.<br>
		Достоинства:
		<ul>
			<li>
				Мы не меняли исходный код Nemo и не вмешивались в его настройки. Т.е. осталась 
возможность запустить оригинальную версию программы в случае необходимости. Кроме того, все изменения касаются только 
одного пользователя. Чтобы вернуть все как было достаточно удалить <code>nemo</code> и <code>libnemohook.so</code> 
из <code>~/bin/</code>.

			<li>
				Несмотря на неэлегантность, костыль будет работать даже после обновления Nemo. 
				Сломаться он может только лишь в случае мажорного релиза Nemo или библиотеки GIO 
				(особенно если измениться имя функции). 
		</ul>
			
		Недостатки:
		<ul>
			<li>
				Hook может скрыть только тома, ассоциированные с физическим диском. Например, разделы 
				на физическом диске (даже если файловая система занимает весь диска, как UDF). Но, как 
				говорилось в части 2 !тут будет ссылка на часть 2!, тома, которые не связаны с 
				физическим диском, hook не спрячет. Так же hook не поможет в случае с дисками, которые 
не поддерживают функцию автоматического обнаружения (например, FDD): такой диск будет 
всегда отображаться на боковой панели (за подробностями обращайтесь к строкам 
<a 
href="https://github.com/linuxmint/nemo/blob/751bacba6f9e4730241d1b69536e2934b1fa6c81/src/nemo-places-sidebar.
c#L1019">№№1019-1027 файла <i>nemo-places-sidebar.c</i></a>).
		</ul>
		
		<p>
                        &#9135;&#9135;&#9135;&#9135;&#9135;
                        <ol>
                                <li id="footnote-1-bottom">
                                        <p>
                                                <a href="#footnote-1-top" title="Перейти к основному тексту">&uarr;</a> 
                                                Я проверял только в Linux Mint 17.1 Cinnamon 32bit.

                        </ol>

		<hr>

		<h1>
			<big>
				<a href="#" title="Перейти к началу страницы">&uarr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>
	</body>
</html>
