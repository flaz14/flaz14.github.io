<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Несмонтированные диски - с глаз долой. Часть 3</title>
	</head>

	<body>
		<h1>
			<big>
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>

		<hr>

		<h1>
			<a href=
		"здесь будет полная (с именем сервера) ссылка на эту же страницу">
				Несмонтированные диски - с глаз долой. Часть 3
			</a>
		</h1>

		<h2>Проверяем ограничения</h2>

		<p>
			Кроме самого hook'а я подготовил тестовую программу, которая ведет себя так же, как и Nemo. 
			Исходные тексты находятся в
			<a href="http://flaz14.github.io/how-to-hide-non-mounted-drives/code"> том же каталоге, что и 
			сама статья</a> (или
<a href="https://github.com/flaz14/flaz14.github.io/tree/master/how-to-hide-non-mounted-drives/code">см. Github</a>.
			Для начала разберемся с ограничениями, о которых говорилось в  
<a href="http://flaz14.github.io/how-to-hide-non-mounted-drives/how-to-hide-non-mounted-drives-part-2.html">части 2
			</a>. 

		<p>
			Воспроизведем ситуацию, описанную в <a 
href="http://flaz14.github.io/how-to-hide-non-mounted-drives/how-to-hide-non-mounted-drives-part-1.html#illustration-1-
1">части 1</a>. 
			Итак, подключим флешку, смонтируем диск с меткой <i>8_ext</i> и оставим несмонтированным диск с 
			меткой <i>8_ntfs</i>. 
			
		<p>
			Запустим тестовую программу:
<pre>
yura@athlonx2 ~/Projects/flaz14.github.io/how-to-hide-non-mounted-drives/code $ make test
./application

Hi! I'm sample application!

+ /dev/sdb2 [8_ext]
- /dev/sdb1 [8_ntfs]

Bye!
</pre>
			Как видно из вывода, Nemo "видит" смонтированный диск с меткой <i>8_ext</i> и несмонтированный 
			диск с меткой <i>8_ntfs</i>.
			
		<p>
			Теперь запустим тестовую программу с hook'ом:
			
<pre>
yura@athlonx2 ~/Projects/flaz14.github.io/how-to-hide-non-mounted-drives/code $ make test-hook
gcc -Wall -g -shared -ldl -fPIC `pkg-config --cflags gtk+-3.0` libnemohook.c -o libnemohook.so `pkg-config --libs 
gtk+-3.0`
LD_PRELOAD=./libnemohook.so ./application

Hi! I'm sample application!

>
    /dev/sda
<
>
    /dev/sr0
<
>
    /dev/sdb
<
+ /dev/sdb2 [8_ext]

Bye!
</pre>
			
		Итак, 
<pre>
>
    /dev/...
<
</pre>
		означает, что hook перехватил обращение к функции <code>g_drive_get_volumes()</code>. Так, первым 
		физическим диском, тома на котром попытался бы получить Nemo, является 
		<code>/dev/sda</code>. На это диске не нашлось томов, поскольку <code>g_drive_get_volumes()</code> 
		покажет только те тома, которых нет в <code>/etc/fstab</code>). Далее, для физического диска 
		<code>/dev/sr0</code> тоже не нашлось дисков (перед запуском тестовой программы в приводе оптических 
		дисков было пусто). А вот на физическом диске <code>/dev/sdb</code> нашелся один только один том. 
		Сравним результаты:
		<ul>
			<li>
				Без hook'а:
<pre>
+ /dev/sdb2 [8_ext]
- /dev/sdb1 [8_ntfs]
</pre>
				
				
			
			<li>
				C hook'ом:
<pre>
+ /dev/sdb2 [8_ext]
</pre>
		</ul>
		
		Как видно, несмонтированный раздел куда-то пропал. Именно этого мы и добивались.
		

			
			
			

		<hr>

		<h1>
			<big>
				<a href="#" title="Перейти к началу страницы">&uarr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>
	</body>
</html>
