<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Несмонтированные диски - с глаз долой. Часть 1</title>
	</head>
	
	<body>
		<h1>
			<big>
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>

		<hr>
		
		<h1>
			<a href=
		"здесь будет полная (с именем сервера) ссылка на эту же страницу">
				Несмонтированные диски - с глаз долой. Часть 1
			</a>
		</h1>
		
		<h2>Что не так с Nemo?</h2>
	
		<p>
			В Linux Mint Cinnamon в качестве файлового менеджера по-умолчанию установлен 
			<a href="https://github.com/linuxmint/nemo">Nemo</a>. По-моему, это очень хорошая программа: 
			быстрая и в меру функциальная. Но есть в ней один недостаток: Nemo всегда отображает 
			несмонтированные диски. Например, когда к компьютеру подключена флешка, разбитая на два 
			раздела, и первый раздел (с меткой <i>8_ext</i>) смонтирован (обратите 	внимание на значок 
			извлечения диска напротив), а второй (с меткой <i>8_ntfs</i>) несмонтирован (значка извлечения 
			нет), то все равно на боковой панели отображаются оба раздела, как на 
			<a href="#illustration-1-1">рисунке 1.1</a>. 
			Если случайно кликнуть на <i>8_ntfs</i>, то Nemo смонтирует этот раздел (даже если 
			автоматическое 				монтирование отключено). Такое поведение не всегда меня 
			устраивает. Например, на компьютере с 				Dual Boot я не хочу видеть 
			разделы Windows. Если же мне вдруг понадобиться что-то скопировать с 			диска 
			C:, или же произвести на нем восстановительные работы, я всегда смогу смонтировать 		
			соответсвующий раздел вручную из командой строки с нужными мне опциями (например, 
			Read Only).
			
		<h4>
			<a id="illustration-1-1">
				Рисунок 1.1 - пример отображения несмонтированного диска на боковой панели Nemo
			</a>
		</h4>
		<img alt="Пример отображения несмонтированного диска на боковой панели Nemo" 
		src="illustrations/nemo-sidebar-with-unmounted-drive-visible.png" width="240px">

			
		<p>
			К сожалению, в Nemo нет возможности скрыть несмонтированные диски. Я 
			облазил все настройки и ничего связанного с этим не нашел. Действительно, судя по исходному 
			коду Nemo (здесь и далее рассматривается версия <b>2.4.5</b>, но в последней версии 
			<b>3.0.6</b> то же 
			самое), отвечающему за отображение значков на боковой панели, фрагмент которого  
			приведен в <a href="#listing-1">листинге 1</a> (многие строки опущены для краткости), это 
			поведение никак не настраивается и не отключается. Это подтверждается и комментариями в строках 
			№992 - №999 и №1089.
			
<h4><a id="listing-1">Листинг 1 - </a>
<a 
href="https://github.com/linuxmint/nemo/blob/751bacba6f9e4730241d1b69536e2934b1fa6c81/src/nemo-places-sidebar.c#L992">
фрагмент файла nemo-places-sidebar.c
</a>
</h4>
<pre>
   ...
   946	    /* first go through all connected drives */
   947	    drives = g_volume_monitor_get_connected_drives (volume_monitor);
   948	
   949	    for (l = drives; l != NULL; l = l->next) {
   950	        drive = l->data;
   951	
   952	        volumes = g_drive_get_volumes (drive);
   953	        if (volumes != NULL) {
   954	            for (ll = volumes; ll != NULL; ll = ll->next) {
   ...                  ...
   965	                mount = g_volume_get_mount (volume);
   966	                if (mount != NULL) {
   967	                    /* Show mounted volume in the sidebar */
   ...                      ...
   991	                } else {
   992	                    /* Do show the unmounted volumes in the sidebar;
   993	                     * this is so the user can mount it (in case automounting
   994	                     * is off).
   995	                     *
   996	                     * Also, even if automounting is enabled, this gives a visual
   997	                     * cue that the user should remember to yank out the media if
   998	                     * he just unmounted it.
   999	                     */
   ...                      ...
  1014	                }
  1015	                g_object_unref (volume);
  1016	            }
  1017	            g_list_free (volumes);
   ...              ...
  1045	
  1046	    /* add all volumes that is not associated with a drive */
  1047	    volumes = g_volume_monitor_get_volumes (volume_monitor);
  1048	    for (l = volumes; l != NULL; l = l->next) {
   ...          ...
  1066	        mount = g_volume_get_mount (volume);
  1067	        if (mount != NULL) {
   ...              ...
  1088	        } else {
  1089	            /* see comment above in why we add an icon for an unmounted mountable volume */
   ...              ...
  1099	        }
  1100	        g_object_unref (volume);
  1101	    }
  1102	    g_list_free (volumes);
   ...
</pre>

		<h2>Возможное решение 1</h2>

		<p>
			Убираем ненужные строки в исходнике, компилируем доработанную версию Nemo и установить его в 
			систему.<br>
			Достоинства:<br>
			<ul>
				<li>
					очень элегантное решение (объем кода, а следовательно, и размер программы 
					уменьшается!)
			
				<li>
					100% будет работать
			</ul>
				
			Недостатки:<br>
			<ul>
				<li>
					для компиляции и сборки, кроме собственно gcc, make и набора библиотек 
					Gnome для разработчика, придется установить дополнительные утилиты: всякие 
					autotools и т.п. А после того как все заработает, придется еще "очистить" 
					систему от ненужных более пакетов
						
				<li>
					придется всегда хранить на компьютере исходники Nemo, иначе не получиться 
					удалить программу (справедливости ради стоит отметить, что можно создать свой 
					пакет на основе исходных текстов, и затем обращаться с ним так же, как и с 
					обычными пакетами).
					
				<li>
					как только Nemo установлен (неважно, из исходных текстов или из самодельного 
					пакета), его уже не получиться обновлять из официальных репозиториев (а даже 
					если и можно было бы, официальная версия Nemo затерла бы нашу, доработанную, и 
					мы пришли бы к тому, с чего начали)
			</ul>
					
		<h2>Возможное решение 2</h2>
	
		<p>
			Внести изменения в конфигурацию <a 
			href="https://git.gnome.org/browse/gvfs/tree/monitor/udisks2/what-is-shown.txt">
			gvfs-udisks2-volume-monitor</a>, чтобы прослойка между Nemo и ядром рапортовала
			об отсутствии дисков, если те не были смонтированы.<br>
			Достоинства:<br>
			<ul>
				<li>
					вообще не надо трогать Nemo 
				<li>
					скорее всего будет работать как надо
			</ul>	
			Недостатки:<br>
			<ul>
				<li>
					изменения затронут не только Nemo, но и другие 
					программы, которые используют возможности Gnome. Что 
					нежелательно, например, для программы для записи компакт 
					дисков.
			</ul>

		<h2>
			
		<h2>Возможное решение 3</h2>
		
		<p>
			Перехватить функцию библиотеки Gnome, которая отвечает за перечисление дисков (несмонтированных
			в том числе), отбросить несмонтированные диски и вернуть список в Nemo, чтобы он ничего не 
			заметил. Далее см. часть 2 !тут будет ссылка на часть 2!

		<hr>
		
		<h1>
			<big>
				<a href="#" title="Перейти к началу страницы">&uarr;</a>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href="/" title="Перейти на главную страницу">&#8962;</a>
			</big>
		</h1>
	</body>
</html>
